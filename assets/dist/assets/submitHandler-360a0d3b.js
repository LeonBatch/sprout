/*
 * @link https://sprout.barrelstrengthdesign.com
 * @copyright Copyright (c) Barrel Strength Design LLC
 * @license https://craftcms.github.io/license
 */class h{constructor(e,r={}){this.formId=e,this.form=document.getElementById(this.formId),this.submitButtons=this.form.querySelectorAll('[type="submit"]'),this.messageBoxId=this.formId+"-message-box",this.successMessageClass=r.successMessageClass??"sproutforms-message-success",this.errorMessageClass=r.errorMessageClass??"sproutforms-message-errors",this.failureMessage=r.failureMessage??"Submission failed",this.messageElement=r.messageElement??"div",this.errorsContainerElement=r.errorsContainerElement??"ul.errors",this.errorsItemElement=r.errorsItemElement??"li",this.fieldWrapperIdPrefix=r.fieldWrapperIdPrefix??"fields-",this.fieldWrapperIdSuffix=r.fieldWrapperIdSuffix??"-field",this.fieldWrapperQuerySelector=r.fieldWrapperQuerySelector??".field",this.addFormSubmitEventListener()}addFormSubmitEventListener(){let e=this;e.form.addEventListener("submit",function(r){r.target&&(r.preventDefault(),e.handleBeforeFormSubmit())},!1)}handleBeforeFormSubmit(){let e=this;this.getBeforeFormSubmitPromise().then(e.onFormSubmitEvent.bind(e)).then(()=>{e.handleFormSubmit()}).catch(e.onFormSubmitCancelledEvent.bind(e))}handleFormSubmit(){let e=this;this.getFormSubmitPromise().then(e.onAfterFormSubmitEvent.bind(e)).catch(e.onFormSubmitCancelledEvent.bind(e))}getBeforeFormSubmitPromise(){let e=this;const r=new CustomEvent("beforeSproutFormsSubmit",{detail:{promises:[]},bubbles:!0,cancelable:!0});return new Promise((t,l)=>{if(!e.form.dispatchEvent(r))return l(!1);let s=r.detail.promises;return Promise.all(s).then(function(o){for(const i of o)if(i===!1)return l(!1)}).catch(function(){return l(!1)}),t(!0)})}onFormSubmitEvent(){let e=this;const r=new CustomEvent("onSproutFormsSubmit",{detail:{submitHandler:e},bubbles:!0,cancelable:!0});return new Promise((t,l)=>e.form.dispatchEvent(r)?t(!0):l(!1))}getFormSubmitPromise(){let e=this,r=e.form.dataset.submissionMethod;return new Promise(async t=>{r==="async"?await e.submitAsync():e.form.submit(),t(!0)})}onAfterFormSubmitEvent(){const e=new CustomEvent("afterSproutFormsSubmit",{bubbles:!0});this.form.dispatchEvent(e)}onFormSubmitCancelledEvent(){const e=new CustomEvent("onSproutFormsSubmitCancelled",{bubbles:!0});this.form.dispatchEvent(e)}submitAsync(){let e=this;return new Promise(async r=>{let t=new XMLHttpRequest;t.onreadystatechange=function(){if(t.readyState!==4)return;let s=JSON.parse(t.responseText);if(t.status>=200||t.status<300){e.removeInlineErrors();let o=document.getElementById(e.messageBoxId);if(o!==null&&o.parentNode.removeChild(o),s.success)s.message&&e.displayMessageBox({id:e.messageBoxId,message:s.message,messageClass:e.successMessageClass}),e.form.reset();else{let i=s&&s.errorDisplayMethod?["global","both"].indexOf(s.errorDisplayMethod)>=0:!1,n=s&&s.errorDisplayMethod?["inline","both"].indexOf(s.errorDisplayMethod)>=0:!1,m=[];if(i)for(let a of Object.entries(s.errors))a[1]!==void 0&&(m=[...m,...a[1]]);let d=e.getErrorList(m);if((s.message||d)&&e.displayMessageBox({id:e.messageBoxId,message:s.message??null,messageClass:e.errorMessageClass,errors:d}),n)for(let[a,p]of Object.entries(s.errors)){let g=e.fieldWrapperIdPrefix+a+e.fieldWrapperIdSuffix,f=document.getElementById(g),c="."+e.getTargetElementClasses(e.errorsContainerElement).join("."),u=f.querySelector(c);u&&u.parentNode.removeChild(u),f.append(e.getErrorList(p))}}}else{let o={};typeof s.error=="string"&&(o=e.getErrorList([s.error])),e.displayMessageBox({id:e.messageBoxId,message:"<p>"+e.failureMessage+"</p>",messageClass:e.errorMessageClass,errors:o})}r(!0)};let l=new FormData(e.form);t.open("POST","/"),t.setRequestHeader("Accept","application/json"),t.send(l)})}displayMessageBox(e){let r=this,t=e.id??null,l=e.message??null,s=e.messageClass??"",o=e.errors??null,i=r.getElementWithClasses(r.messageElement);t&&i.setAttribute("id",t),i.classList.add(s),i.innerHTML=l,o&&i.append(o);let n=document.getElementById(r.messageBoxId);n?n.parentNode.replaceChild(i,n):r.form.prepend(i)}removeInlineErrors(){let e=this,t=e.getTargetElementClasses(e.errorsContainerElement).map(s=>"."+s),l=document.querySelectorAll(e.fieldWrapperQuerySelector);for(const s of l){let o=s.querySelector(t);o!==null&&o.parentNode.removeChild(o)}}getErrorList(e){let r=this,t=r.getElementWithClasses(r.errorsContainerElement);for(let l of e){let s=r.getElementWithClasses(r.errorsItemElement);s.innerHTML=l,t.appendChild(s)}return t}getElementWithClasses(e){let r=this;if(typeof e!="string")return null;let t=r.getTargetElementName(e),l=r.getTargetElementClasses(e);if(!t)return null;let s=document.createElement(t);if(l!==null&&l.length)for(const o of l)s.classList.add(o);return s}getTargetElementName(e){let r=e.split(".");return r.length>0?r[0]:null}getTargetElementClasses(e){let r=e.split(".");return r.length>1?r.slice(1,r.length):null}}window.SproutFormsSubmitHandler=h;
//# sourceMappingURL=submitHandler-360a0d3b.js.map
